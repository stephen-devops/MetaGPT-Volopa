%%{init: {'theme': 'default', 'themeVariables': { 'fontFamily': 'Inter' }}}%%

sequenceDiagram
    participant C as Client
    participant R as Route
    participant MC as MassPaymentFileController
    participant FR as UploadMassPaymentFileRequest
    participant P as MassPaymentFilePolicy
    participant MS as MassPaymentFileService
    participant CVS as CsvValidationService
    participant VJ as ValidateMassPaymentFileJob
    participant M as MassPaymentFile
    participant MR as MassPaymentFileResource
    participant Q as Queue
    
    Note over C,Q: File Upload Flow
    C->>R: POST /api/v1/mass-payment-files (multipart/form-data)
    R->>MC: store(UploadMassPaymentFileRequest)
    MC->>FR: validate()
    FR->>FR: rules() - file validation
    FR->>P: authorize() - check permissions
    P-->>FR: return true/false
    FR-->>MC: validation passed
    MC->>MS: create(validated_data, uploaded_file)
    MS->>M: DB::transaction()
    MS->>M: create(file_metadata)
    MS->>CVS: validateFile(uploaded_file)
    CVS-->>MS: return initial_validation
    MS->>Q: dispatch(ValidateMassPaymentFileJob)
    MS->>M: commit()
    MS-->>MC: return MassPaymentFile
    MC->>MR: new MassPaymentFileResource(file)
    MR-->>MC: return formatted_response
    MC-->>C: HTTP 201 Created with status='processing'
    
    Note over Q,VJ: Async Validation Processing
    Q->>VJ: handle(CsvValidationService)
    VJ->>CVS: validateFile(file_path)
    CVS->>CVS: validateRow() for each row
    CVS->>CVS: checkCurrencyRules(currency, row_data)
    CVS-->>VJ: return validation_results
    VJ->>M: update(status='validation_completed')
    
    Note over C,MC: Status Polling Flow
    C->>R: GET /api/v1/mass-payment-files/{id}
    R->>MC: show(id)
    MC->>P: authorize(view)
    P-->>MC: return true
    MC->>M: with(['paymentInstructions', 'tccAccount'])
    M-->>MC: return loaded_model
    MC->>MR: new MassPaymentFileResource(file)
    MR-->>MC: return formatted_response
    MC-->>C: HTTP 200 OK with current status
    
    Note over C,MC: Approval Flow
    C->>R: POST /api/v1/mass-payment-files/{id}/approve
    R->>MC: approve(ApproveMassPaymentFileRequest, file)
    MC->>P: authorize(approve)
    P-->>MC: return true
    MC->>MS: approve(file, user)
    MS->>M: DB::transaction()
    MS->>M: update(status='approved')
    MS->>Q: dispatch(ProcessPaymentInstructionsJob)
    MS->>M: commit()
    MS-->>MC: return success
    MC-->>C: HTTP 200 OK
