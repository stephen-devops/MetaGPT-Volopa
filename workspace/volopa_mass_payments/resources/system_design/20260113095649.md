## Implementation approach

We will build a Laravel 10 API system following the Mental Model: Client → route (versioned, throttled, auth) → controller → FormRequest (validation + policy) → service/model (domain logic, transactions) → API Resource (shape output) → JSON. The system uses async queue processing for large file operations, implements OAuth2/WSSE authentication, multi-tenant architecture with client_id scoping, and follows strict controller-service separation. Key challenges addressed: (1) Processing up to 10,000 payment rows using Laravel queues to prevent timeouts, (2) Implementing currency-specific validation and approval workflows, (3) Creating first-approver-wins notification system with bell notifications, (4) Providing detailed row-level error reporting, (5) Maintaining complete audit trails. Architecture follows DOS patterns: thin controllers, FormRequest validation, Policy authorization, service layer business logic, API Resources for responses, eager loading to prevent N+1 queries, pagination for all lists, DB transactions for multi-write operations, and caching for reference data.

## File list

- routes/api.php
- app/Http/Controllers/Api/V1/MassPaymentFileController.php
- app/Http/Controllers/Api/V1/PaymentInstructionController.php
- app/Http/Controllers/Api/V1/TemplateController.php
- app/Http/Requests/UploadMassPaymentFileRequest.php
- app/Http/Requests/ApproveMassPaymentFileRequest.php
- app/Http/Requests/CreatePaymentInstructionRequest.php
- app/Http/Resources/MassPaymentFileResource.php
- app/Http/Resources/PaymentInstructionResource.php
- app/Http/Resources/ValidationErrorResource.php
- app/Models/MassPaymentFile.php
- app/Models/PaymentInstruction.php
- app/Models/Beneficiary.php
- app/Models/TccAccount.php
- app/Services/MassPaymentFileService.php
- app/Services/CsvValidationService.php
- app/Services/PaymentProcessingService.php
- app/Services/TemplateGenerationService.php
- app/Policies/MassPaymentFilePolicy.php
- app/Jobs/ValidateMassPaymentFileJob.php
- app/Jobs/ProcessPaymentInstructionsJob.php
- app/Notifications/ApprovalRequiredNotification.php
- database/migrations/2026_01_13_000001_create_mass_payment_files_table.php
- database/migrations/2026_01_13_000002_create_payment_instructions_table.php
- config/queue.php
- config/cache.php

## Data structures and interfaces


classDiagram
    class MassPaymentFileController {
        +index(Request): JsonResponse
        +store(UploadMassPaymentFileRequest): JsonResponse
        +show(string, MassPaymentFile): JsonResponse
        +approve(ApproveMassPaymentFileRequest, MassPaymentFile): JsonResponse
        +destroy(MassPaymentFile): JsonResponse
    }
    class PaymentInstructionController {
        +index(Request): JsonResponse
        +store(CreatePaymentInstructionRequest): JsonResponse
        +show(string, PaymentInstruction): JsonResponse
    }
    class TemplateController {
        +download(Request): Response
    }
    class UploadMassPaymentFileRequest {
        +authorize(): bool
        +rules(): array
        +messages(): array
    }
    class ApproveMassPaymentFileRequest {
        +authorize(): bool
        +rules(): array
    }
    class MassPaymentFileService {
        +create(array, UploadedFile): MassPaymentFile
        +approve(MassPaymentFile, User): bool
        +processValidation(MassPaymentFile): void
        +delete(MassPaymentFile): bool
    }
    class CsvValidationService {
        +validateFile(UploadedFile): array
        +validateRow(array, int): array
        +checkCurrencyRules(string, array): bool
    }
    class PaymentProcessingService {
        +createInstructions(MassPaymentFile, array): Collection
        +processPayments(MassPaymentFile): bool
    }
    class MassPaymentFile {
        +id: string
        +client_id: string
        +tcc_account_id: string
        +filename: string
        +status: enum
        +total_amount: decimal
        +currency: string
        +created_at: timestamp
        +updated_at: timestamp
        +tccAccount(): BelongsTo
        +paymentInstructions(): HasMany
        +approvals(): HasMany
    }
    class PaymentInstruction {
        +id: string
        +mass_payment_file_id: string
        +beneficiary_id: string
        +amount: decimal
        +currency: string
        +purpose_code: string
        +created_at: timestamp
        +massPaymentFile(): BelongsTo
        +beneficiary(): BelongsTo
    }
    class Beneficiary {
        +id: string
        +client_id: string
        +name: string
        +account_number: string
        +bank_code: string
        +country: string
        +created_at: timestamp
        +paymentInstructions(): HasMany
    }
    class MassPaymentFileResource {
        +toArray(Request): array
    }
    class PaymentInstructionResource {
        +toArray(Request): array
    }
    class MassPaymentFilePolicy {
        +view(User, MassPaymentFile): bool
        +create(User): bool
        +approve(User, MassPaymentFile): bool
        +delete(User, MassPaymentFile): bool
    }
    class ValidateMassPaymentFileJob {
        +handle(CsvValidationService): void
    }
    class ProcessPaymentInstructionsJob {
        +handle(PaymentProcessingService): void
    }
    
    MassPaymentFileController --> MassPaymentFileService
    MassPaymentFileController --> MassPaymentFileResource
    MassPaymentFileController --> UploadMassPaymentFileRequest
    MassPaymentFileController --> ApproveMassPaymentFileRequest
    MassPaymentFileService --> MassPaymentFile
    MassPaymentFileService --> ValidateMassPaymentFileJob
    MassPaymentFileService --> CsvValidationService
    MassPaymentFile --> PaymentInstruction
    MassPaymentFile --> TccAccount
    PaymentInstruction --> Beneficiary
    ValidateMassPaymentFileJob --> CsvValidationService
    ProcessPaymentInstructionsJob --> PaymentProcessingService


## Program call flow


sequenceDiagram
    participant C as Client
    participant R as Route
    participant MC as MassPaymentFileController
    participant FR as UploadMassPaymentFileRequest
    participant P as MassPaymentFilePolicy
    participant MS as MassPaymentFileService
    participant CVS as CsvValidationService
    participant VJ as ValidateMassPaymentFileJob
    participant M as MassPaymentFile
    participant MR as MassPaymentFileResource
    participant Q as Queue
    
    Note over C,Q: File Upload Flow
    C->>R: POST /api/v1/mass-payment-files (multipart/form-data)
    R->>MC: store(UploadMassPaymentFileRequest)
    MC->>FR: validate()
    FR->>FR: rules() - file validation
    FR->>P: authorize() - check permissions
    P-->>FR: return true/false
    FR-->>MC: validation passed
    MC->>MS: create(validated_data, uploaded_file)
    MS->>M: DB::transaction()
    MS->>M: create(file_metadata)
    MS->>CVS: validateFile(uploaded_file)
    CVS-->>MS: return initial_validation
    MS->>Q: dispatch(ValidateMassPaymentFileJob)
    MS->>M: commit()
    MS-->>MC: return MassPaymentFile
    MC->>MR: new MassPaymentFileResource(file)
    MR-->>MC: return formatted_response
    MC-->>C: HTTP 201 Created with status='processing'
    
    Note over Q,VJ: Async Validation Processing
    Q->>VJ: handle(CsvValidationService)
    VJ->>CVS: validateFile(file_path)
    CVS->>CVS: validateRow() for each row
    CVS->>CVS: checkCurrencyRules(currency, row_data)
    CVS-->>VJ: return validation_results
    VJ->>M: update(status='validation_completed')
    
    Note over C,MC: Status Polling Flow
    C->>R: GET /api/v1/mass-payment-files/{id}
    R->>MC: show(id)
    MC->>P: authorize(view)
    P-->>MC: return true
    MC->>M: with(['paymentInstructions', 'tccAccount'])
    M-->>MC: return loaded_model
    MC->>MR: new MassPaymentFileResource(file)
    MR-->>MC: return formatted_response
    MC-->>C: HTTP 200 OK with current status
    
    Note over C,MC: Approval Flow
    C->>R: POST /api/v1/mass-payment-files/{id}/approve
    R->>MC: approve(ApproveMassPaymentFileRequest, file)
    MC->>P: authorize(approve)
    P-->>MC: return true
    MC->>MS: approve(file, user)
    MS->>M: DB::transaction()
    MS->>M: update(status='approved')
    MS->>Q: dispatch(ProcessPaymentInstructionsJob)
    MS->>M: commit()
    MS-->>MC: return success
    MC-->>C: HTTP 200 OK


## Anything UNCLEAR

The specific OAuth2 implementation details and WSSE signature validation mechanisms need clarification - should we integrate with existing Volopa auth services or implement custom middleware? The exact currency-specific approval rules matrix needs definition - which currencies require mandatory approval and what are the threshold amounts? The notification delivery mechanism for bell notifications needs specification - should we implement WebSocket real-time notifications or polling-based updates? The database relationships between existing TccAccount, Beneficiary models and new MassPaymentFile, PaymentInstruction tables need detailed foreign key mappings. The file storage location and cleanup strategy for uploaded CSV files needs specification - local storage, S3, or database blob storage?

