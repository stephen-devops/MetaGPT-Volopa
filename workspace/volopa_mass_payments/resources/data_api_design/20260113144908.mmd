%%{init: {'theme': 'default', 'themeVariables': { 'fontFamily': 'Inter' }}}%%

classDiagram
    class MassPaymentFileController {
        +upload(UploadMassPaymentFileRequest request) JsonResponse
        +show(string id) JsonResponse
        +index(Request request) JsonResponse
        +approve(ApproveMassPaymentFileRequest request, string id) JsonResponse
        +destroy(string id) JsonResponse
    }
    
    class PaymentInstructionController {
        +index(GetPaymentInstructionsRequest request) JsonResponse
        +show(string id) JsonResponse
    }
    
    class TemplateController {
        +downloadRecipientTemplate(string currency) BinaryFileResponse
        +downloadBlankTemplate(string currency) BinaryFileResponse
    }
    
    class UploadMassPaymentFileRequest {
        +rules() array
        +authorize() bool
        +messages() array
    }
    
    class ApproveMassPaymentFileRequest {
        +rules() array
        +authorize() bool
    }
    
    class MassPaymentFileService {
        +uploadFile(UploadedFile file, int clientId, int tccAccountId) MassPaymentFile
        +approveFile(string fileId, int approverId) MassPaymentFile
        +getFileStatus(string fileId) array
        +deleteFile(string fileId) bool
    }
    
    class CsvValidationService {
        +validateCsvStructure(string filePath) array
        +validatePaymentInstructions(array instructions) array
        +validateCurrencySpecificFields(array instruction, string currency) array
    }
    
    class PaymentProcessingService {
        +processPaymentInstructions(MassPaymentFile file) void
        +updatePaymentStatus(PaymentInstruction instruction, string status) void
    }
    
    class TemplateService {
        +generateRecipientTemplate(string currency, int clientId) string
        +generateBlankTemplate(string currency) string
        +getRecipientsByClientAndCurrency(int clientId, string currency) Collection
    }
    
    class MassPaymentFile {
        +id: string
        +client_id: int
        +tcc_account_id: int
        +filename: string
        +original_filename: string
        +file_size: int
        +total_amount: decimal
        +currency: string
        +status: string
        +validation_errors: json
        +uploaded_by: int
        +approved_by: int
        +approved_at: datetime
        +created_at: datetime
        +updated_at: datetime
        +client() BelongsTo
        +tccAccount() BelongsTo
        +paymentInstructions() HasMany
        +uploader() BelongsTo
        +approver() BelongsTo
    }
    
    class PaymentInstruction {
        +id: string
        +mass_payment_file_id: string
        +beneficiary_id: int
        +amount: decimal
        +currency: string
        +purpose_code: string
        +reference: string
        +status: string
        +validation_errors: json
        +row_number: int
        +created_at: datetime
        +updated_at: datetime
        +massPaymentFile() BelongsTo
        +beneficiary() BelongsTo
    }
    
    class Beneficiary {
        +id: int
        +client_id: int
        +name: string
        +account_number: string
        +bank_code: string
        +country: string
        +created_at: datetime
        +updated_at: datetime
        +paymentInstructions() HasMany
    }
    
    class MassPaymentFileResource {
        +toArray(Request request) array
    }
    
    class PaymentInstructionResource {
        +toArray(Request request) array
    }
    
    class MassPaymentFilePolicy {
        +view(User user, MassPaymentFile file) bool
        +create(User user) bool
        +update(User user, MassPaymentFile file) bool
        +delete(User user, MassPaymentFile file) bool
        +approve(User user, MassPaymentFile file) bool
    }
    
    class ValidateMassPaymentFileJob {
        +handle(CsvValidationService validator) void
    }
    
    class ProcessPaymentInstructionsJob {
        +handle(PaymentProcessingService processor) void
    }
    
    MassPaymentFileController --> MassPaymentFileService
    MassPaymentFileController --> MassPaymentFileResource
    PaymentInstructionController --> PaymentInstructionResource
    TemplateController --> TemplateService
    MassPaymentFileService --> CsvValidationService
    MassPaymentFileService --> ValidateMassPaymentFileJob
    MassPaymentFileService --> MassPaymentFile
    CsvValidationService --> PaymentInstruction
    PaymentProcessingService --> ProcessPaymentInstructionsJob
    MassPaymentFile --> PaymentInstruction
    MassPaymentFile --> Beneficiary
    PaymentInstruction --> Beneficiary
    PaymentInstruction --> MassPaymentFile
