%%{init: {'theme': 'default', 'themeVariables': { 'fontFamily': 'Inter' }}}%%

classDiagram
    class MassPaymentFileController {
        +store(UploadMassPaymentFileRequest request): JsonResponse
        +show(int id): JsonResponse
        +index(Request request): JsonResponse
        +approve(int id, ApproveMassPaymentFileRequest request): JsonResponse
        +delete(int id): JsonResponse
    }
    class TemplateController {
        +download(string currency): Response
    }
    class PaymentInstructionController {
        +store(CreatePaymentInstructionRequest request): JsonResponse
        +index(Request request): JsonResponse
        +show(int id): JsonResponse
    }
    class UploadMassPaymentFileRequest {
        +rules(): array
        +authorize(): bool
        +messages(): array
    }
    class ApproveMassPaymentFileRequest {
        +rules(): array
        +authorize(): bool
    }
    class MassPaymentFileService {
        +uploadFile(array data, UploadedFile file): MassPaymentFile
        +approveFile(MassPaymentFile file, int approverId): MassPaymentFile
        +getFileStatus(int fileId): array
        +deleteFile(MassPaymentFile file): bool
    }
    class CsvValidationService {
        +validateCsvStructure(string filePath): array
        +validateRowData(array row, int rowNumber): array
        +validateBeneficiaryExists(string identifier): bool
    }
    class PaymentProcessingService {
        +createPaymentInstructions(MassPaymentFile file): array
        +processPayments(array instructions): bool
    }
    class TemplateService {
        +generateTemplate(string currency, int clientId): string
        +getBeneficiariesByCurrency(string currency, int clientId): Collection
    }
    class MassPaymentFile {
        +id: int
        +client_id: int
        +tcc_account_id: int
        +filename: string
        +file_path: string
        +status: string
        +total_rows: int
        +valid_rows: int
        +error_rows: int
        +validation_errors: array
        +uploaded_by: int
        +approved_by: int
        +approved_at: datetime
        +tccAccount(): BelongsTo
        +paymentInstructions(): HasMany
        +uploader(): BelongsTo
        +approver(): BelongsTo
    }
    class PaymentInstruction {
        +id: int
        +mass_payment_file_id: int
        +beneficiary_id: int
        +amount: decimal
        +currency: string
        +purpose_code: string
        +reference: string
        +status: string
        +massPaymentFile(): BelongsTo
        +beneficiary(): BelongsTo
    }
    class TccAccount {
        +id: int
        +client_id: int
        +account_number: string
        +currency: string
        +balance: decimal
        +massPaymentFiles(): HasMany
    }
    class Beneficiary {
        +id: int
        +client_id: int
        +name: string
        +account_number: string
        +sort_code: string
        +currency: string
        +paymentInstructions(): HasMany
    }
    class MassPaymentFilePolicy {
        +view(User user, MassPaymentFile file): bool
        +create(User user): bool
        +approve(User user, MassPaymentFile file): bool
        +delete(User user, MassPaymentFile file): bool
    }
    class ProcessMassPaymentFileJob {
        +handle(): void
        -massPaymentFile: MassPaymentFile
        -csvValidationService: CsvValidationService
        -paymentProcessingService: PaymentProcessingService
    }
    class MassPaymentFileResource {
        +toArray(Request request): array
    }
    class PaymentInstructionResource {
        +toArray(Request request): array
    }
    
    MassPaymentFileController --> MassPaymentFileService
    MassPaymentFileController --> MassPaymentFileResource
    TemplateController --> TemplateService
    PaymentInstructionController --> PaymentProcessingService
    PaymentInstructionController --> PaymentInstructionResource
    MassPaymentFileService --> MassPaymentFile
    MassPaymentFileService --> ProcessMassPaymentFileJob
    CsvValidationService --> Beneficiary
    PaymentProcessingService --> PaymentInstruction
    TemplateService --> Beneficiary
    TemplateService --> TccAccount
    MassPaymentFile --> TccAccount
    MassPaymentFile --> PaymentInstruction
    PaymentInstruction --> MassPaymentFile
    PaymentInstruction --> Beneficiary
    ProcessMassPaymentFileJob --> CsvValidationService
    ProcessMassPaymentFileJob --> PaymentProcessingService
    ProcessMassPaymentFileJob --> MassPaymentFile
