## Required packages

- league/csv
- spatie/laravel-permission
- laravel/sanctum

## Required Other language third-party packages

- No third-party dependencies required

## Logic Analysis

- ['database/migrations/2024_01_01_000001_create_mass_payment_files_table.php', 'Creates mass_payment_files table with status, validation fields, and foreign keys. No dependencies.']
- ['database/migrations/2024_01_01_000002_create_payment_instructions_table.php', 'Creates payment_instructions table with FK to mass_payment_files. Depends on mass_payment_files migration.']
- ['app/Models/MassPaymentFile.php', 'Eloquent model for mass payment files with relationships and client isolation scope. Depends on migration.']
- ['app/Models/PaymentInstruction.php', 'Eloquent model for payment instructions with relationships. Depends on both migrations and MassPaymentFile model.']
- ['app/Models/TccAccount.php', 'Existing model enhancement for relationships. May be modified to add HasMany relationship.']
- ['app/Models/Beneficiary.php', 'Existing model enhancement for relationships. May be modified to add HasMany relationship.']
- ['app/Policies/MassPaymentFilePolicy.php', 'Authorization policies for mass payment operations. Depends on MassPaymentFile model.']
- ['app/Http/Requests/UploadMassPaymentFileRequest.php', 'Form request for file upload validation and authorization. Depends on MassPaymentFilePolicy.']
- ['app/Http/Requests/ApproveMassPaymentFileRequest.php', 'Form request for file approval validation and authorization. Depends on MassPaymentFilePolicy.']
- ['app/Http/Requests/CreatePaymentInstructionRequest.php', 'Form request for payment instruction creation. Depends on PaymentInstruction model.']
- ['app/Services/MassPaymentFileService.php', 'Business logic for file operations and status management. Depends on models and jobs.']
- ['app/Services/CsvValidationService.php', 'CSV parsing and validation logic with currency-specific rules. Depends on Beneficiary model.']
- ['app/Services/PaymentProcessingService.php', 'Service for creating payment instructions from validated CSV. Depends on PaymentInstruction model.']
- ['app/Services/TemplateService.php', 'Service for generating CSV templates and beneficiary retrieval. Depends on Beneficiary and TccAccount models.']
- ['app/Jobs/ProcessMassPaymentFileJob.php', 'Async job for file processing workflow. Depends on services and models.']
- ['app/Jobs/ValidateCsvFileJob.php', 'Async job for CSV validation. Depends on CsvValidationService.']
- ['app/Notifications/FileApprovalRequiredNotification.php', 'Notification for approval workflow. Depends on MassPaymentFile model.']
- ['app/Http/Resources/MassPaymentFileResource.php', 'API resource for consistent response transformation. Depends on MassPaymentFile model.']
- ['app/Http/Resources/PaymentInstructionResource.php', 'API resource for payment instruction responses. Depends on PaymentInstruction model.']
- ['app/Http/Controllers/Api/V1/MassPaymentFileController.php', 'Thin controller for mass payment file endpoints. Depends on services, requests, and resources.']
- ['app/Http/Controllers/Api/V1/PaymentInstructionController.php', 'Controller for payment instruction endpoints. Depends on PaymentProcessingService and resources.']
- ['app/Http/Controllers/Api/V1/TemplateController.php', 'Controller for template download endpoints. Depends on TemplateService.']
- ['routes/api.php', 'API route definitions with middleware and versioning. Depends on all controllers.']

## Task list

- database/migrations/2024_01_01_000001_create_mass_payment_files_table.php
- database/migrations/2024_01_01_000002_create_payment_instructions_table.php
- app/Models/MassPaymentFile.php
- app/Models/PaymentInstruction.php
- app/Models/TccAccount.php
- app/Models/Beneficiary.php
- app/Policies/MassPaymentFilePolicy.php
- app/Http/Requests/UploadMassPaymentFileRequest.php
- app/Http/Requests/ApproveMassPaymentFileRequest.php
- app/Http/Requests/CreatePaymentInstructionRequest.php
- app/Services/CsvValidationService.php
- app/Services/TemplateService.php
- app/Services/PaymentProcessingService.php
- app/Services/MassPaymentFileService.php
- app/Jobs/ValidateCsvFileJob.php
- app/Jobs/ProcessMassPaymentFileJob.php
- app/Notifications/FileApprovalRequiredNotification.php
- app/Http/Resources/MassPaymentFileResource.php
- app/Http/Resources/PaymentInstructionResource.php
- app/Http/Controllers/Api/V1/TemplateController.php
- app/Http/Controllers/Api/V1/PaymentInstructionController.php
- app/Http/Controllers/Api/V1/MassPaymentFileController.php
- routes/api.php

## Full API spec

openapi: 3.0.0
info:
  title: Volopa Mass Payments API
  version: 1.0.0
paths:
  /api/v1/templates/{currency}/download:
    get:
      summary: Download CSV template for currency
      parameters:
        - name: currency
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: CSV template file
          content:
            text/csv:
              schema:
                type: string
  /api/v1/mass-payment-files:
    post:
      summary: Upload mass payment file
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                tcc_account_id:
                  type: integer
      responses:
        '201':
          description: File uploaded successfully
        '422':
          description: Validation errors
    get:
      summary: List mass payment files
      responses:
        '200':
          description: List of files
  /api/v1/mass-payment-files/{id}:
    get:
      summary: Get file details
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: File details
    delete:
      summary: Delete file
      responses:
        '204':
          description: File deleted
  /api/v1/mass-payment-files/{id}/approve:
    post:
      summary: Approve mass payment file
      responses:
        '200':
          description: File approved
  /api/v1/payment-instructions:
    get:
      summary: List payment instructions
      responses:
        '200':
          description: List of instructions
    post:
      summary: Create payment instruction
      responses:
        '201':
          description: Instruction created

## Shared Knowledge

All models use client_id for multi-tenant isolation via global scopes. Controllers follow thin controller pattern delegating to services. FormRequests handle validation and authorization. Queue jobs process large files asynchronously. API Resources ensure consistent response formats. Use Laravel's built-in authentication middleware for route protection.

## Anything UNCLEAR

The authentication middleware choice between OAuth2 vs WSSE needs clarification based on client type. INR currency validation rules require business rule specifications. Approval notification timing (immediate vs post-validation) needs decision. The relationship between existing beneficiary models and CSV recipient data needs architectural alignment.

